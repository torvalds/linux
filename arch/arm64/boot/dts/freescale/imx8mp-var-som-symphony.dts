// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2024 Variscite Ltd.
 */

#include "imx8mp-var-som.dtsi"

/ {
	model = "Variscite VAR-SOM-MX8M-PLUS on Symphony-Board";
	compatible = "variscite,var-som-mx8mp-symphony", "variscite,var-som-mx8mp", "fsl,imx8mp";

	chosen {
		stdout-path = &uart2;
	};

	gpio-leds {
		compatible = "gpio-leds";

		led-0 {
			function = LED_FUNCTION_POWER;
			gpios = <&pca9534 0 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "heartbeat";
		};
	};

	reg_usdhc2_vmmc: regulator-usdhc2-vmmc {
		compatible = "regulator-fixed";
		regulator-name = "VSD_3V3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		gpios = <&gpio4 22 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		startup-delay-us = <100>;
		off-on-delay-us = <12000>;
	};

	reg_usdhc2_vqmmc: regulator-usdhc2-vqmmc {
		compatible = "regulator-gpio";
		regulator-name = "VSD_VSEL";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <3300000>;
		gpios = <&gpio2 12 GPIO_ACTIVE_HIGH>;
		states = <3300000 0x0 1800000 0x1>;
		vin-supply = <&ldo5>;
	};
};

&i2c3 {
	clock-frequency = <400000>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c3>;
	status = "okay";

	/* GPIO expander */
	pca9534: gpio@20 {
		compatible = "nxp,pca9534";
		reg = <0x20>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_pca9534>;
		gpio-controller;
		#gpio-cells = <2>;
		interrupt-parent = <&gpio1>;
		interrupts = <15 IRQ_TYPE_EDGE_FALLING>;
		wakeup-source;

		usb3-sata-sel-hog {
			gpio-hog;
			gpios = <4 0>;
			output-low;
			line-name = "usb3_sata_sel";
		};
	};
};

/* Console */
&uart2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_uart2>;
	status = "okay";
};

/* SD-card */
&usdhc2 {
	pinctrl-names = "default", "state_100mhz", "state_200mhz";
	pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_usdhc2_gpio>;
	pinctrl-1 = <&pinctrl_usdhc2_100mhz>, <&pinctrl_usdhc2_gpio>;
	pinctrl-2 = <&pinctrl_usdhc2_200mhz>, <&pinctrl_usdhc2_gpio>;
	cd-gpios = <&gpio1 14 GPIO_ACTIVE_LOW>;
	vmmc-supply = <&reg_usdhc2_vmmc>;
	vqmmc-supply = <&reg_usdhc2_vqmmc>;
	bus-width = <4>;
	status = "okay";
};

&iomuxc {
	pinctrl_i2c3: i2c3grp {
		fsl,pins = <
			MX8MP_IOMUXC_I2C3_SCL__I2C3_SCL                                 0x400001c2
			MX8MP_IOMUXC_I2C3_SDA__I2C3_SDA                                 0x400001c2
		>;
	};

	pinctrl_pca9534: pca9534grp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO15__GPIO1_IO15                             0xc0
		>;
	};

	pinctrl_uart2: uart2grp {
		fsl,pins = <
			MX8MP_IOMUXC_UART2_RXD__UART2_DCE_RX                            0x40
			MX8MP_IOMUXC_UART2_TXD__UART2_DCE_TX                            0x40
		>;
	};

	pinctrl_usdhc2_gpio: usdhc2-gpiogrp {
		fsl,pins = <
			MX8MP_IOMUXC_GPIO1_IO14__GPIO1_IO14                             0x1c4
			MX8MP_IOMUXC_SAI2_RXC__GPIO4_IO22                               0x10
			MX8MP_IOMUXC_SD2_CD_B__GPIO2_IO12                               0xc0
		>;
	};

	pinctrl_usdhc2: usdhc2grp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_CLK__USDHC2_CLK                                0x190
			MX8MP_IOMUXC_SD2_CMD__USDHC2_CMD                                0x1d0
			MX8MP_IOMUXC_SD2_DATA0__USDHC2_DATA0                            0x1d0
			MX8MP_IOMUXC_SD2_DATA1__USDHC2_DATA1                            0x1d0
			MX8MP_IOMUXC_SD2_DATA2__USDHC2_DATA2                            0x1d0
			MX8MP_IOMUXC_SD2_DATA3__USDHC2_DATA3                            0x1d0
		>;
	};

	pinctrl_usdhc2_100mhz: usdhc2-100mhzgrp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_CLK__USDHC2_CLK                                0x194
			MX8MP_IOMUXC_SD2_CMD__USDHC2_CMD                                0x1d4
			MX8MP_IOMUXC_SD2_DATA0__USDHC2_DATA0                            0x1d4
			MX8MP_IOMUXC_SD2_DATA1__USDHC2_DATA1                            0x1d4
			MX8MP_IOMUXC_SD2_DATA2__USDHC2_DATA2                            0x1d4
			MX8MP_IOMUXC_SD2_DATA3__USDHC2_DATA3                            0x1d4
		>;
	};

	pinctrl_usdhc2_200mhz: usdhc2-200mhzgrp {
		fsl,pins = <
			MX8MP_IOMUXC_SD2_CLK__USDHC2_CLK                                0x196
			MX8MP_IOMUXC_SD2_CMD__USDHC2_CMD                                0x1d6
			MX8MP_IOMUXC_SD2_DATA0__USDHC2_DATA0                            0x1d6
			MX8MP_IOMUXC_SD2_DATA1__USDHC2_DATA1                            0x1d6
			MX8MP_IOMUXC_SD2_DATA2__USDHC2_DATA2                            0x1d6
			MX8MP_IOMUXC_SD2_DATA3__USDHC2_DATA3                            0x1d6
		>;
	};
};
