/*
 *  linux/init/main.c
 *
 *  Copyright (C) 1991, 1992  Linus Torvalds
 *
 *  GK 2/5/95  -  Changed to support mounting root fs via NFS
 *  Added initrd & change_root: Werner Almesberger & Hans Lermen, Feb '96
 *  Moan early if gcc is old, avoiding bogus kernels - Paul Gortmaker, May '96
 *  Simplified starting of init:  Michael A. Griffith <grif@acm.org>
 */
#define DEBUG		/* Enable initcall_debug */
#include <linux/types.h>
#include <linux/extable.h>
#include <linux/module.h>
#include <linux/proc_fs.h>
#include <linux/binfmts.h>
#include <linux/kernel.h>
#include <linux/syscalls.h>
#include <linux/stackprotector.h>
#include <linux/string.h>
#include <linux/ctype.h>
#include <linux/delay.h>
#include <linux/ioport.h>
#include <linux/init.h>
#include <linux/initrd.h>
#include <linux/bootmem.h>
#include <linux/acpi.h>
#include <linux/console.h>
#include <linux/nmi.h>
#include <linux/percpu.h>
#include <linux/kmod.h>
#include <linux/vmalloc.h>
#include <linux/kernel_stat.h>
#include <linux/start_kernel.h>
#include <linux/security.h>
#include <linux/smp.h>
#include <linux/profile.h>
#include <linux/rcupdate.h>
#include <linux/moduleparam.h>
#include <linux/kallsyms.h>
#include <linux/writeback.h>
#include <linux/cpu.h>
#include <linux/cpuset.h>
#include <linux/cgroup.h>
#include <linux/efi.h>
#include <linux/tick.h>
#include <linux/interrupt.h>
#include <linux/taskstats_kern.h>
#include <linux/delayacct.h>
#include <linux/unistd.h>
#include <linux/rmap.h>
#include <linux/mempolicy.h>
#include <linux/key.h>
#include <linux/buffer_head.h>
#include <linux/page_ext.h>
#include <linux/debug_locks.h>
#include <linux/debugobjects.h>
#include <linux/lockdep.h>
#include <linux/kmemleak.h>
#include <linux/pid_namespace.h>
#include <linux/device.h>
#include <linux/kthread.h>
#include <linux/sched.h>
#include <linux/sched/init.h>
#include <linux/signal.h>
#include <linux/idr.h>
#include <linux/kgdb.h>
#include <linux/ftrace.h>
#include <linux/async.h>
#include <linux/kmemcheck.h>
#include <linux/sfi.h>
#include <linux/shmem_fs.h>
#include <linux/slab.h>
#include <linux/perf_event.h>
#include <linux/ptrace.h>
#include <linux/blkdev.h>
#include <linux/elevator.h>
#include <linux/sched_clock.h>
#include <linux/sched/task.h>
#include <linux/sched/task_stack.h>
#include <linux/context_tracking.h>
#include <linux/random.h>
#include <linux/list.h>
#include <linux/integrity.h>
#include <linux/proc_ns.h>
#include <linux/io.h>
#include <linux/cache.h>
#include <linux/rodata_test.h>
#include <asm/io.h>
#include <asm/bugs.h>
#include <asm/setup.h>
#include <asm/sections.h>
#include <asm/cacheflush.h>
staticintkernel_init(void*);externvoidinit_IRQ(void);externvoidfork_init(void);externvoidradix_tree_init(void);/**Debughelper:viathisflagweknowthatwearein'earlybootupcode'*whereonlythebootprocessorisrunningwithIRQdisabled.Thismeans*twothings-IRQmustnotbeenabledbeforetheflagisclearedandsome*operationswhicharenotallowedwithIRQdisabledareallowedwhilethe*flagisset.*/boolearly_boot_irqs_disabled__read_mostly;enumsystem_statessystem_state__read_mostly;EXPORT_SYMBOL(system_state);/**Bootcommand-linearguments*/#defineMAX_INIT_ARGSCONFIG_INIT_ENV_ARG_LIMIT#defineMAX_INIT_ENVSCONFIG_INIT_ENV_ARG_LIMITexternvoidtime_init(void);/*DefaultlatetimeinitisNULL.archscanoverridethislater.*/void(*__initdatalate_time_init)(void);/*Untouchedcommandlinesavedbyarch-specificcode.*/char__initdataboot_command_line[COMMAND_LINE_SIZE];/*Untouchedsavedcommandline(eg.for/proc)*/char*saved_command_line;/*Commandlineforparameterparsing*/staticchar*static_command_line;/*Commandlineforper-initcallparameterparsing*/staticchar*initcall_command_line;staticchar*execute_command;staticchar*ramdisk_execute_command;/**Usedtogeneratewarningsifstatic_keymanipulationfunctionsareused*beforejump_label_initiscalled.*/boolstatic_key_initialized__read_mostly;EXPORT_SYMBOL_GPL(static_key_initialized);/**Ifset,thisisanindicationtothedriversthatresettheunderlying*devicebeforegoingaheadwiththeinitializationotherwisedrivermight*relyontheBIOSandskiptheresetoperation.**Thisisusefulifkernelisbootinginanunreliableenvironment.*Forex.kdumpsituationwherepreviouskernelhascrashed,BIOShasbeen*skippedanddeviceswillbeinunknownstate.*/unsignedintreset_devices;EXPORT_SYMBOL(reset_devices);staticint__initset_reset_devices(char*str){reset_devices=1;return1;}__setup("reset_devices",set_reset_devices);staticconstchar*argv_init[MAX_INIT_ARGS+2]={"init",NULL,};constchar*envp_init[MAX_INIT_ENVS+2]={"HOME=/","TERM=linux",NULL,};staticconstchar*panic_later,*panic_param;externconststructobs_kernel_param__setup_start[],__setup_end[];staticbool__initobsolete_checksetup(char*line){conststructobs_kernel_param*p;boolhad_early_param=false;p=__setup_start;do{intn=strlen(p->str);if(parameqn(line,p->str,n)){if(p->early){/*Alreadydoneinparse_early_param?*(Needsexactmatchonparampart).*Keepiterating,aswecanhaveearly*paramsand__setupsofsamenames8(*/if(line[n]=='\0'||line[n]=='=')had_early_param=true;}elseif(!p->setup_func){pr_warn("Parameter%sisobsolete,ignored\n",p->str);returntrue;}elseif(p->setup_func(line+n))returntrue;}p++;}while(p<__setup_end);returnhad_early_param;}/**Thisshouldbeapprox2Bo*oMipstostart(noteinitialshift),andwill*stillworkevenifinitiallytoolarge,itwilljusttakeslightlylonger*/unsignedlongloops_per_jiffy=(1<<12);EXPORT_SYMBOL(loops_per_jiffy);staticint__initdebug_kernel(char*str){console_loglevel=CONSOLE_LOGLEVEL_DEBUG;return0;}staticint__initquiet_kernel(char*str){console_loglevel=CONSOLE_LOGLEVEL_QUIET;return0;}early_param("debug",debug_kernel);early_param("quiet",quiet_kernel);staticint__initloglevel(char*str){intnewlevel;/**Onlyupdateloglevelvaluewhenacorrectsettingwaspassed,*topreventblindcrashes(whenloglevelbeingsetto0)that*arequitehardtodebug*/if(get_option(&str,&newlevel)){console_loglevel=newlevel;return0;}return-EINVAL;}early_param("loglevel",loglevel);/*ChangeNULtermbackto"=",tomake"param"thewholestring.*/staticint__initrepair_env_string(char*param,char*val,constchar*unused,void*arg){if(val){/*param=valorparam="val"?*/if(val==param+strlen(param)+1)val[-1]='=';elseif(val==param+strlen(param)+2){val[-2]='=';memmove(val-1,val,strlen(val)+1);val--;}elseBUG();}return0;}/*Anythingafter--getshandedstraighttoinit.*/staticint__initset_init_arg(char*param,char*val,constchar*unused,void*arg){unsignedinti;if(panic_later)return0;repair_env_string(param,val,unused,NULL);for(i=0;argv_init[i];i++){if(i==MAX_INIT_ARGS){panic_later="init";panic_param=param;return0;}}argv_init[i]=param;return0;}/**Unknownbootoptionsgethandedtoinit,unlesstheylooklike*unusedparameters(modprobewillfindthemin/proc/cmdline).*/staticint__initunknown_bootoption(char*param,char*val,constchar*unused,void*arg){repair_env_string(param,val,unused,NULL);/*Handleobsolete-styleparameters*/if(obsolete_checksetup(param))return0;/*Unusedmoduleparameter.*/if(strchr(param,'.')&&(!val||strchr(param,'.')<val))return0;if(panic_later)return0;if(val){/*Environmentoption*/unsignedinti;for(i=0;envp_init[i];i++){if(i==MAX_INIT_ENVS){panic_later="env";panic_param=param;}if(!strncmp(param,envp_init[i],val-param))break;}envp_init[i]=param;}else{/*Commandlineoption*/unsignedinti;for(i=0;argv_init[i];i++){if(i==MAX_INIT_ARGS){panic_later="init";panic_param=param;}}argv_init[i]=param;}return0;}staticint__initinit_setup(char*str){unsignedinti;execute_command=str;/**IncaseLILOisgoingtobootuswithdefaultcommandline,*itprepends"auto"beforethewholecmdlinewhichmakes*theshellthinkitshouldexecuteascriptwithsuchname.*Soweignoreallargumentsentered_before_init=...[MJ]*/for(i=1;i<MAX_INIT_ARGS;i++)argv_init[i]=NULL;return1;}__setup("init=",init_setup);staticint__initrdinit_setup(char*str){unsignedinti;ramdisk_execute_command=str;/*See"auto"commentininit_setup*/for(i=1;i<MAX_INIT_ARGS;i++)argv_init[i]=NULL;return1;}__setup("rdinit=",rdinit_setup);#ifndefCONFIG_SMPstaticconstunsignedintsetup_max_cpus=NR_CPUS;staticinlinevoidsetup_nr_cpu_ids(void){}staticinlinevoidsmp_prepare_cpus(unsignedintmaxcpus){}#endif/**Weneedtostoretheuntouchedcommandlineforfuturereference.*Wealsoneedtostorethetouchedcommandlinesincetheparameter*parsingisperformedinplace,andweshouldallowacomponentto*storereferenceofname/valueforfuturereference.*/staticvoid__initsetup_command_line(char*command_line){saved_command_line=memblock_virt_alloc(strlen(boot_command_line)+1,0);initcall_command_line=memblock_virt_alloc(strlen(boot_command_line)+1,0);static_command_line=memblock_virt_alloc(strlen(command_line)+1,0);strcpy(saved_command_line,boot_command_line);strcpy(static_command_line,command_line);}/**Weneedtofinalizeinanon-__initfunctionorelseraceconditions*betweentherootthreadandtheinitthreadmaycausestart_kernelto*bereapedbyfree_initmembeforetherootthreadhasproceededto*cpu_idle.**gcc-3.4accidentallyinlinesthisfunction,sousenoinline.*/static__initdataDECLARE_COMPLETION(kthreadd_done);staticnoinlinevoid__refrest_init(void){structtask_struct*tsk;intpid;rcu_scheduler_starting();/**Weneedtospawninitfirstsothatitobtainspid1,however*theinittaskwillendupwantingtocreatekthreads,which,if*wescheduleitbeforewecreatekthreadd,willOOPS.*/pid=kernel_thread(kernel_init,NULL,CLONE_FS);/**PininitonthebootCPU.Taskmigrationisnotproperlyworking*untilsched_init_smp()hasbeenrun.Itwillsettheallowed*CPUsforinittothenonisolatedCPUs.*/rcu_read_lock();tsk=find_task_by_pid_ns(pid,&init_pid_ns);set_cpus_allowed_ptr(tsk,cpumask_of(smp_processor_id()));rcu_read_unlock();numa_default_policy();pid=kernel_thread(kthreadd,NULL,CLONE_FS|CLONE_FILES);rcu_read_lock();kthreadd_task=find_task_by_pid_ns(pid,&init_pid_ns);rcu_read_unlock();/**Enablemight_sleep()andsmp_processor_id()checks.*TheycannotbeenabledearlierbecausewithCONFIG_PRREMPT=y*kernel_thread()wouldtriggermight_sleep()splats.With*CONFIG_PREEMPT_VOLUNTARY=ytheinittaskmighthavescheduled*already,butit'sstuckonthekthreadd_donecompletion.*/system_state=SYSTEM_SCHEDULING;complete(&kthreadd_done);/**Thebootidlethreadmustexecuteschedule()*atleastoncetogetthingsmoving:*/init_idle_bootup_task(current);schedule_preempt_disabled();/*Callintocpu_idlewithpreemptdisabled*/cpu_startup_entry(CPUHP_ONLINE);}/*Checkforearlyparams.*/staticint__initdo_early_param(char*param,char*val,constchar*unused,void*arg){conststructobs_kernel_param*p;for(p=__setup_start;p<__setup_end;p++){if((p->early&&parameq(param,p->str))||(strcmp(param,"console")==0&&strcmp(p->str,"earlycon")==0)){if(p->setup_func(val)!=0)pr_warn("Malformedearlyoption'%s'\n",param);}}/*Weaccepteverythingatthisstage.*/return0;}void__initparse_early_options(char*cmdline){parse_args("earlyoptions",cmdline,NULL,0,0,0,NULL,do_early_param);}/*Archcodecallsthisearlyon,orifnot,justbeforeotherparsing.*/void__initparse_early_param(void){staticintdone__initdata;staticchartmp_cmdline[COMMAND_LINE_SIZE]__initdata;if(done)return;/*Allfallthroughtodo_early_param.*/strlcpy(tmp_cmdline,boot_command_line,COMMAND_LINE_SIZE);parse_early_options(tmp_cmdline);done=1;}void__init__weakarch_post_acpi_subsys_init(void){}void__init__weaksmp_setup_processor_id(void){}#ifTHREAD_SIZE>=PAGE_SIZEvoid__init__weakthread_stack_cache_init(void){}#endif/**Setupkernelmemoryallocators*/staticvoid__initmm_init(void){/**page_extrequirescontiguouspages,*biggerthanMAX_ORDERunlessSPARSEMEM.*/page_ext_init_flatmem();mem_init();kmem_cache_init();percpu_init_late();pgtable_init();vmalloc_init();ioremap_huge_init();}asmlinkage__visiblevoid__initstart_kernel(void){char*command_line;char*after_dashes;set_task_stack_end_magic(&init_task);smp_setup_processor_id();debug_objects_early_init();/**SetuptheinitialcanaryASAP:*/add_latent_entropy();boot_init_stack_canary();cgroup_init_early();local_irq_disable();early_boot_irqs_disabled=true;/**Interruptsarestilldisabled.Donecessarysetups,then*enablethem.*/boot_cpu_init();page_address_init();pr_notice("%s",linux_banner);setup_arch(&command_line);mm_init_cpumask(&init_mm);setup_command_line(command_line);setup_nr_cpu_ids();setup_per_cpu_areas();boot_cpu_state_init();smp_prepare_boot_cpu();/*arch-specificboot-cpuhooks*/build_all_zonelists(NULL,NULL);page_alloc_init();pr_notice("Kernelcommandline:%s\n",boot_command_line);parse_early_param();after_dashes=parse_args("Bootingkernel",static_command_line,__start___param,__stop___param-__start___param,-1,-1,NULL,&unknown_bootoption);if(!IS_ERR_OR_NULL(after_dashes))parse_args("Settinginitargs",after_dashes,NULL,0,-1,-1,NULL,set_init_arg);jump_label_init();/**Theseuselargebootmemallocationsandmustprecede*kmem_cache_init()*/setup_log_buf(0);pidhash_init();vfs_caches_init_early();sort_main_extable();trap_init();mm_init();ftrace_init();/*trace_printkcanbeenabledhere*/early_trace_init();/**Setuptheschedulerpriorstartinganyinterrupts(suchasthe*timerinterrupt).Fulltopologysetuphappensatsmp_init()*time-butmeanwhilewestillhaveafunctioningscheduler.*/sched_init();/**Disablepreemption-earlybootupschedulingisextremely*fragileuntilwecpu_idle()forthefirsttime.*/preempt_disable();if(WARN(!irqs_disabled(),"Interruptswereenabled*very*early,fixingit\n"))local_irq_disable();radix_tree_init();/**Allowworkqueuecreationandworkitemqueueing/cancelling*early.Workitemexecutiondependsonkthreadsandstartsafter*workqueue_init().*/workqueue_init_early();rcu_init();/*Traceeventsareavailableafterthis*/trace_init();context_tracking_init();/*initsomelinksbeforeinit_ISA_irqs()*/early_irq_init();init_IRQ();tick_init();rcu_init_nohz();init_timers();hrtimers_init();softirq_init();timekeeping_init();time_init();sched_clock_postinit();printk_safe_init();perf_event_init();profile_init();call_function_init();WARN(!irqs_disabled(),"Interruptswereenabledearly\n");early_boot_irqs_disabled=false;local_irq_enable();kmem_cache_init_late();/**HACKALERT!Thisisearly.We'reenablingtheconsolebefore*we'vedonePCIsetupsetc,andconsole_init()mustbeawareof*this.Butwedowantoutputearly,incasesomethinggoeswrong.*/console_init();if(panic_later)panic("Toomanyboot%svarsat`%s'",panic_later,panic_param);lockdep_info();/**Needtorunthiswhenirqsareenabled,becauseitwants*toself-test[hard/soft]-irqson/offlockinversionbugs*too:*/locking_selftest();#ifdefCONFIG_BLK_DEV_INITRDif(initrd_start&&!initrd_below_start_ok&&page_to_pfn(virt_to_page((void*)initrd_start))<min_low_pfn){pr_crit("initrdoverwritten(0x%08lx<0x%08lx)-disablingit.\n",page_to_pfn(virt_to_page((void*)initrd_start)),min_low_pfn);initrd_start=0;}#endifpage_ext_init();debug_objects_mem_init();kmemleak_init();setup_per_cpu_pageset();numa_policy_init();if(late_time_init)late_time_init();calibrate_delay();pidmap_init();anon_vma_init();acpi_early_init();#ifdefCONFIG_X86if(efi_enabled(EFI_RUNTIME_SERVICES))efi_enter_virtual_mode();#endif#ifdefCONFIG_X86_ESPFIX64/*Shouldberunbeforethefirstnon-initthreadiscreated*/init_espfix_bsp();#endifthread_stack_cache_init();cred_init();fork_init();proc_caches_init();buffer_init();key_init();security_init();dbg_late_init();vfs_caches_init();pagecache_init();signals_init();proc_root_init();nsfs_init();cpuset_init();cgroup_init();taskstats_init_early();delayacct_init();check_bugs();acpi_subsystem_init();arch_post_acpi_subsys_init();sfi_init_late();if(efi_enabled(EFI_RUNTIME_SERVICES)){efi_free_boot_services();}/*Dotherestnon-__init'ed,we'renowalive*/rest_init();}/*Callallconstructorfunctionslinkedintothekernel.*/staticvoid__initdo_ctors(void){#ifdefCONFIG_CONSTRUCTORSctor_fn_t*fn=(ctor_fn_t*)__ctors_start;for(;fn<(ctor_fn_t*)__ctors_end;fn++)(*fn)();#endif}boolinitcall_debug;core_param(initcall_debug,initcall_debug,bool,0644);#ifdefCONFIG_KALLSYMSstructblacklist_entry{structlist_headnext;char*buf;};static__initdata_or_moduleLIST_HEAD(blacklisted_initcalls);staticint__initinitcall_blacklist(char*str){char*str_entry;structblacklist_entry*entry;/*strargumentisacomma-separatedlistoffunctions*/do{str_entry=strsep(&str,",");if(str_entry){pr_debug("blacklistinginitcall%s\n",str_entry);entry=alloc_bootmem(sizeof(*entry));entry->buf=alloc_bootmem(strlen(str_entry)+1);strcpy(entry->buf,str_entry);list_add(&entry->next,&blacklisted_initcalls);}}while(str_entry);return0;}staticbool__init_or_moduleinitcall_blacklisted(initcall_tfn){structblacklist_entry*entry;charfn_name[KSYM_SYMBOL_LEN];unsignedlongaddr;if(list_empty(&blacklisted_initcalls))returnfalse;addr=(unsignedlong)dereference_function_descriptor(fn);sprint_symbol_no_offset(fn_name,addr);/**fnwillbe"function_name[module_name]"where[module_name]isnot*displayedforbuilt-ininitfunctions.Stripoffthe[module_name].*/strreplace(fn_name,'','\0');list_for_each_entry(entry,&blacklisted_initcalls,next){if(!strcmp(fn_name,entry->buf)){pr_debug("initcall%sblacklisted\n",fn_name);returntrue;}}returnfalse;}#elsestaticint__initinitcall_blacklist(char*str){pr_warn("initcall_blacklistrequiresCONFIG_KALLSYMS\n");return0;}staticbool__init_or_moduleinitcall_blacklisted(initcall_tfn){returnfalse;}#endif__setup("initcall_blacklist=",initcall_blacklist);staticint__init_or_moduledo_one_initcall_debug(initcall_tfn){ktime_tcalltime,delta,rettime;unsignedlonglongduration;intret;printk(KERN_DEBUG"calling%pF@%i\n",fn,task_pid_nr(current));calltime=ktime_get();ret=fn();rettime=ktime_get();delta=ktime_sub(rettime,calltime);duration=(unsignedlonglong)ktime_to_ns(delta)>>10;printk(KERN_DEBUG"initcall%pFreturned%dafter%lldusecs\n",fn,ret,duration);returnret;}int__init_or_moduledo_one_initcall(initcall_tfn){intcount=preempt_count();intret;charmsgbuf[64];if(initcall_blacklisted(fn))return-EPERM;if(initcall_debug)ret=do_one_initcall_debug(fn);elseret=fn();msgbuf[0]=0;if(preempt_count()!=count){sprintf(msgbuf,"preemptionimbalance");preempt_count_set(count);}if(irqs_disabled()){strlcat(msgbuf,"disabledinterrupts",sizeof(msgbuf));local_irq_enable();}WARN(msgbuf[0],"initcall%pFreturnedwith%s\n",fn,msgbuf);add_latent_entropy();returnret;}externinitcall_t__initcall_start[];externinitcall_t__initcall0_start[];externinitcall_t__initcall1_start[];externinitcall_t__initcall2_start[];externinitcall_t__initcall3_start[];externinitcall_t__initcall4_start[];externinitcall_t__initcall5_start[];externinitcall_t__initcall6_start[];externinitcall_t__initcall7_start[];externinitcall_t__initcall_end[];staticinitcall_t*initcall_levels[]__initdata={__initcall0_start,__initcall1_start,__initcall2_start,__initcall3_start,__initcall4_start,__initcall5_start,__initcall6_start,__initcall7_start,__initcall_end,};/*Keeptheseinsyncwithinitcallsininclude/linux/init.h*/staticchar*initcall_level_names[]__initdata={"early","core","postcore","arch","subsys","fs","device","late",};staticvoid__initdo_initcall_level(intlevel){initcall_t*fn;strcpy(initcall_command_line,saved_command_line);parse_args(initcall_level_names[level],initcall_command_line,__start___param,__stop___param-__start___param,level,level,NULL,&repair_env_string);for(fn=initcall_levels[level];fn<initcall_levels[level+1];fn++)do_one_initcall(*fn);}staticvoid__initdo_initcalls(void){intlevel;for(level=0;level<ARRAY_SIZE(initcall_levels)-1;level++)do_initcall_level(level);}/**Ok,themachineisnowinitialized.Noneofthedevices*havebeentouchedyet,buttheCPUsubsystemisupand*running,andmemoryandprocessmanagementworks.**Nowwecanfinallystartdoingsomerealwork..*/staticvoid__initdo_basic_setup(void){cpuset_init_smp();shmem_init();driver_init();init_irq_proc();do_ctors();usermodehelper_enable();do_initcalls();}staticvoid__initdo_pre_smp_initcalls(void){initcall_t*fn;for(fn=__initcall_start;fn<__initcall0_start;fn++)do_one_initcall(*fn);}/**Thisfunctionrequestsmoduleswhichshouldbeloadedbydefaultandis*calledtwicerightafterinitrdismountedandrightbeforeinitis*exec'd.Ifsuchmodulesareoneitherinitrdorrootfs,theywillbe*loadedbeforecontrolispassedtouserland.*/void__initload_default_modules(void){load_default_elevator_module();}staticintrun_init_process(constchar*init_filename){argv_init[0]=init_filename;returndo_execve(getname_kernel(init_filename),(constchar__user*const__user*)argv_init,(constchar__user*const__user*)envp_init);}staticinttry_to_run_init_process(constchar*init_filename){intret;ret=run_init_process(init_filename);if(ret&&ret!=-ENOENT){pr_err("Startinginit:%sexistsbutcouldn'texecuteit(error%d)\n",init_filename,ret);}returnret;}staticnoinlinevoid__initkernel_init_freeable(void);#ifdefined(CONFIG_STRICT_KERNEL_RWX)||defined(CONFIG_STRICT_MODULE_RWX)boolrodata_enabled__ro_after_init=true;staticint__initset_debug_rodata(char*str){returnstrtobool(str,&rodata_enabled);}__setup("rodata=",set_debug_rodata);#endif#ifdefCONFIG_STRICT_KERNEL_RWXstaticvoidmark_readonly(void){if(rodata_enabled){mark_rodata_ro();rodata_test();}elsepr_info("Kernelmemoryprotectiondisabled.\n");}#elsestaticinlinevoidmark_readonly(void){pr_warn("Thisarchitecturedoesnothavekernelmemoryprotection.\n");}#endifstaticint__refkernel_init(void*unused){intret;kernel_init_freeable();/*needtofinishallasync__initcodebeforefreeingthememory*/async_synchronize_full();ftrace_free_init_mem();free_initmem();mark_readonly();system_state=SYSTEM_RUNNING;numa_default_policy();rcu_end_inkernel_boot();if(ramdisk_execute_command){ret=run_init_process(ramdisk_execute_command);if(!ret)return0;pr_err("Failedtoexecute%s(error%d)\n",ramdisk_execute_command,ret);}/**Wetryeachoftheseuntilonesucceeds.**TheBourneshellcanbeusedinsteadofinitifweare*tryingtorecoverareallybrokenmachine.*/if(execute_command){ret=run_init_process(execute_command);if(!ret)return0;panic("Requestedinit%sfailed(error%d).",execute_command,ret);}if(!try_to_run_init_process("/sbin/init")||!try_to_run_init_process("/etc/init")||!try_to_run_init_process("/bin/init")||!try_to_run_init_process("/bin/sh"))return0;panic("Noworkinginitfound.Trypassinginit=optiontokernel.""SeeLinuxDocumentation/admin-guide/init.rstforguidance.");}staticnoinlinevoid__initkernel_init_freeable(void){/**Waituntilkthreaddisallset-up.*/wait_for_completion(&kthreadd_done);/*Nowtheschedulerisfullysetupandcandoblockingallocations*/gfp_allowed_mask=__GFP_BITS_MASK;/**initcanallocatepagesonanynode*/set_mems_allowed(node_states[N_MEMORY]);cad_pid=task_pid(current);smp_prepare_cpus(setup_max_cpus);workqueue_init();init_mm_internals();do_pre_smp_initcalls();lockup_detector_init();smp_init();sched_init_smp();page_alloc_init_late();do_basic_setup();/*Openthe/dev/consoleontherootfs,thisshouldneverfail*/if(sys_open((constchar__user*)"/dev/console",O_RDWR,0)<0)pr_err("Warning:unabletoopenaninitialconsole.\n");(void)sys_dup(0);(void)sys_dup(0);/**checkifthereisanearlyuserspaceinit.Ifyes,letitdoall*thework*/if(!ramdisk_execute_command)ramdisk_execute_command="/init";if(sys_access((constchar__user*)ramdisk_execute_command,0)!=0){ramdisk_execute_command=NULL;prepare_namespace();}/**Ok,wehavecompletedtheinitialbootup,and*we'reessentiallyupandrunning.Getridofthe*initmemsegmentsandstarttheuser-modestuff..**rootfsisavailablenow,tryloadingthepublickeys*anddefaultmodules*/integrity_load_keys();load_default_modules();}
