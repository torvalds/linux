# $OpenBSD: Makefile,v 1.4 2022/12/31 03:35:21 djm Exp $

.PATH: ${.CURDIR}/src ${.CURDIR}/src/cbor ${.CURDIR}/src/cbor/internal

CFLAGS+= -I${.CURDIR}/src -DHAVE_ENDIAN_H -std=c99
# We don't support custom allocators.
CFLAGS+= -D_cbor_malloc=malloc -D_cbor_realloc=realloc -D_cbor_free=free

LIB=	cbor
SRCS=	cbor.c
#SRCS+=	allocators.c

WARNINGS=yes
CDIAGFLAGS+=	-Wall -Wextra -Wno-unused-parameter
CDIAGFLAGS+=	-Wno-missing-field-initializers
#CDIAGFLAGS+=	-Werror

# cbor/
SRCS+= arrays.c bytestrings.c callbacks.c common.c encoding.c floats_ctrls.c
SRCS+= ints.c maps.c serialization.c streaming.c tags.c strings.c 

# cbor/internal
SRCS+= builder_callbacks.c encoders.c loaders.c memory_utils.c
SRCS+= stack.c unicode.c

HDRS=	cbor.h
HDRS+=	cbor/arrays.h cbor/bytestrings.h cbor/callbacks.h cbor/common.h
HDRS+=	cbor/configuration.h cbor/data.h cbor/encoding.h cbor/floats_ctrls.h
HDRS+=	cbor/ints.h cbor/maps.h cbor/serialization.h cbor/streaming.h
HDRS+=	cbor/strings.h cbor/tags.h
# This file is generated by upstream's CMake rules.
HDRS+=	cbor/cbor_export.h

NOMAN=

includes:
	@for i in $(HDRS); do \
		j="test -d ${DESTDIR}/usr/include/`dirname $$i` || \
		    ${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m 755 \
		    ${DESTDIR}/usr/include/`dirname $$i`"; \
		echo $$j; \
		eval "$$j"; \
		j="cmp -s src/$$i ${DESTDIR}/usr/include/$$i || \
		    ${INSTALL} ${INSTALL_COPY} -o ${BINOWN} -g ${BINGRP} \
		    -m 444 ${.CURDIR}/src/$$i ${DESTDIR}/usr/include/$$i"; \
		echo $$j; \
		eval "$$j"; \
	done

.include <bsd.lib.mk>
